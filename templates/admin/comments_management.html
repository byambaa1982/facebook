{% extends "base.html" %}

{% block title %}Comments Management - Admin{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='comments.css') }}">

<div class="comment-management-container container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-comments"></i> Comments Management</h2>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{{ url_for('custom_admin.dashboard') }}">Dashboard</a></li>
                        <li class="breadcrumb-item active">Comments</li>
                    </ol>
                </nav>
            </div>

            <!-- Flash Messages -->
            <div id="flashMessages"></div>

            <!-- Controls Panel -->
            <div class="controls-panel card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-cogs"></i> Controls</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <button class="action-button btn btn-primary me-2" onclick="loadPosts()">
                                <i class="fas fa-refresh"></i> Load Posts
                            </button>
                            <button class="action-button btn btn-success me-2" onclick="bulkFetchComments()">
                                <i class="fas fa-download"></i> Bulk Fetch All Comments
                            </button>
                        </div>
                        <div class="col-md-6 text-end">
                            <div class="view-toggle btn-group" role="group">
                                <button class="btn btn-outline-secondary active" onclick="toggleView('posts')">
                                    <i class="fas fa-file-alt"></i> Posts View
                                </button>
                                <button class="btn btn-outline-secondary" onclick="toggleView('comments')">
                                    <i class="fas fa-comments"></i> Comments View
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading Indicator -->
            <div id="loadingIndicator" class="text-center" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading data...</p>
            </div>

            <!-- Posts View -->
            <div id="postsView" class="card">
                <div class="card-header">
                    <h5><i class="fas fa-file-alt"></i> Posted Content</h5>
                </div>
                <div class="card-body">
                    <div id="postsContainer">
                        <p class="text-muted text-center">Click "Load Posts" to view posted content</p>
                    </div>
                </div>
            </div>

            <!-- Comments View -->
            <div id="commentsView" class="card" style="display: none;">
                <div class="card-header">
                    <h5><i class="fas fa-comments"></i> Comments Management</h5>
                </div>
                <div class="card-body">
                    <div id="commentsContainer">
                        <p class="text-muted text-center">Select a post to view and manage its comments</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Comment Actions Modal -->
<div class="modal fade" id="commentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="commentModalTitle">Comment Actions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="commentModalContent">
                    <!-- Dynamic content will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Reply Modal -->
<div class="modal fade" id="replyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reply to Comment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="replyMessage" class="form-label">Reply Message</label>
                    <textarea class="form-control" id="replyMessage" rows="3" placeholder="Enter your reply..."></textarea>
                </div>
                <div id="replyError" class="alert alert-danger" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitReply()">
                    <i class="fas fa-reply"></i> Send Reply
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.post-card {
    transition: all 0.3s ease;
    border-left: 4px solid #007bff;
}

.post-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.comment-item {
    border-left: 3px solid #28a745;
    background: #f8f9fa;
    transition: all 0.2s ease;
}

.comment-item:hover {
    background: #e9ecef;
}

.reply-item {
    border-left: 3px solid #6c757d;
    margin-left: 20px;
    font-size: 0.9em;
}

.comment-actions {
    opacity: 0;
    transition: opacity 0.2s ease;
}

.comment-item:hover .comment-actions {
    opacity: 1;
}

.stats-badge {
    font-size: 0.8em;
}

.user-avatar {
    width: 32px;
    height: 32px;
    background: linear-gradient(45deg, #007bff, #6f42c1);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 14px;
}

.timestamp {
    color: #6c757d;
    font-size: 0.85em;
}

.bulk-progress {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
}
</style>

<script>
let currentPosts = [];
let currentPageId = '';
let currentCommentId = '';

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadPosts();
});

function showFlashMessage(message, type = 'success') {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    document.getElementById('flashMessages').innerHTML = alertHtml;
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        const alert = document.querySelector('.alert');
        if (alert) {
            alert.remove();
        }
    }, 5000);
}

function showLoading(show = true) {
    document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
}

function toggleView(view) {
    const postsView = document.getElementById('postsView');
    const commentsView = document.getElementById('commentsView');
    
    if (view === 'posts') {
        postsView.style.display = 'block';
        commentsView.style.display = 'none';
    } else {
        postsView.style.display = 'none';
        commentsView.style.display = 'block';
    }
    
    // Update button states
    const buttons = document.querySelectorAll('.btn-group button');
    buttons.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
}

async function loadPosts() {
    showLoading(true);
    
    try {
        const response = await fetch('/admin-panel/api/posts');
        const data = await response.json();
        
        if (data.success) {
            currentPosts = data.posts;
            displayPosts(data.posts);
            showFlashMessage(`Loaded ${data.posts.length} posts successfully`);
        } else {
            showFlashMessage(`Error: ${data.error}`, 'danger');
        }
    } catch (error) {
        showFlashMessage(`Network error: ${error.message}`, 'danger');
    } finally {
        showLoading(false);
    }
}

function displayPosts(posts) {
    const container = document.getElementById('postsContainer');
    
    if (posts.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">No posted content found</p>';
        return;
    }
    
    const postsHtml = posts.map(post => `
        <div class="post-card card mb-3">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h6 class="card-title">${post.title}</h6>
                        <p class="card-text text-muted">${post.description.substring(0, 150)}${post.description.length > 150 ? '...' : ''}</p>
                        <small class="text-muted">
                            <i class="fas fa-calendar"></i> Posted: ${new Date(post.posted_at).toLocaleDateString()}
                            | <i class="fas fa-facebook"></i> Post ID: ${post.facebook_post_id}
                        </small>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="btn-group-vertical w-100">
                            <button class="btn btn-primary btn-sm mb-1" 
                                    onclick="fetchComments('${post.id}', '${post.facebook_post_id}', '${post.posted_to_page}')">
                                <i class="fas fa-download"></i> Fetch Comments
                            </button>
                            <button class="btn btn-info btn-sm mb-1" 
                                    onclick="viewComments('${post.id}', '${post.facebook_post_id}')">
                                <i class="fas fa-eye"></i> View Comments
                            </button>
                            <button class="btn btn-warning btn-sm" 
                                    onclick="refreshComments('${post.id}', '${post.facebook_post_id}', '${post.posted_to_page}')">
                                <i class="fas fa-refresh"></i> Refresh
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = postsHtml;
}

async function fetchComments(contentId, postId, pageId) {
    showLoading(true);
    
    try {
        const response = await fetch(`/admin-panel/api/content/${contentId}/comments/fetch`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                post_id: postId,
                page_id: pageId,
                limit: 25
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showFlashMessage(`Fetched ${data.comments_count} comments successfully`);
            viewComments(contentId, postId);
        } else {
            showFlashMessage(`Error: ${data.error}`, 'danger');
        }
    } catch (error) {
        showFlashMessage(`Network error: ${error.message}`, 'danger');
    } finally {
        showLoading(false);
    }
}

async function viewComments(contentId, postId) {
    showLoading(true);
    
    try {
        const response = await fetch(`/admin-panel/api/content/${contentId}/comments?post_id=${postId}`);
        const data = await response.json();
        
        if (data.success) {
            displayComments(data.comments_data, contentId, postId);
            toggleView('comments');
        } else {
            showFlashMessage(`Error: ${data.error}`, 'danger');
        }
    } catch (error) {
        showFlashMessage(`Network error: ${error.message}`, 'danger');
    } finally {
        showLoading(false);
    }
}

function displayComments(commentsData, contentId, postId) {
    const container = document.getElementById('commentsContainer');
    
    if (!commentsData || !commentsData.comments || commentsData.comments.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">No comments found for this post</p>';
        return;
    }
    
    const post = currentPosts.find(p => p.id === contentId);
    const pageId = post ? post.posted_to_page : '';
    
    const headerHtml = `
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h6><i class="fas fa-comments"></i> Comments (${commentsData.total_comments})</h6>
            <div>
                <span class="badge bg-info">Last Updated: ${new Date(commentsData.last_updated).toLocaleString()}</span>
                <button class="btn btn-sm btn-outline-primary ms-2" onclick="toggleView('posts')">
                    <i class="fas fa-arrow-left"></i> Back to Posts
                </button>
            </div>
        </div>
    `;
    
    const commentsHtml = commentsData.comments.map(comment => {
        const repliesHtml = comment.replies && comment.replies.data ? 
            comment.replies.data.map(reply => `
                <div class="reply-item p-2 mt-2 rounded">
                    <div class="d-flex align-items-start">
                        <div class="user-avatar me-2">${reply.from.name.charAt(0).toUpperCase()}</div>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>${reply.from.name}</strong>
                                    <span class="timestamp ms-2">${new Date(reply.created_time).toLocaleString()}</span>
                                </div>
                                <div class="comment-actions">
                                    <button class="btn btn-outline-danger btn-sm" 
                                            onclick="deleteComment('${reply.id}', '${pageId}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <p class="mb-1 mt-1">${reply.message}</p>
                            <small class="text-muted">
                                <i class="fas fa-heart"></i> ${reply.like_count || 0} likes
                            </small>
                        </div>
                    </div>
                </div>
            `).join('') : '';
        
        return `
            <div class="comment-item p-3 mb-3 rounded">
                <div class="d-flex align-items-start">
                    <div class="user-avatar me-3">${comment.from.name.charAt(0).toUpperCase()}</div>
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>${comment.from.name}</strong>
                                <span class="timestamp ms-2">${new Date(comment.created_time).toLocaleString()}</span>
                            </div>
                            <div class="comment-actions">
                                <button class="btn btn-outline-primary btn-sm me-1" 
                                        onclick="openReplyModal('${comment.id}', '${pageId}', '${comment.from.name}')">
                                    <i class="fas fa-reply"></i>
                                </button>
                                <button class="btn btn-outline-danger btn-sm" 
                                        onclick="deleteComment('${comment.id}', '${pageId}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <p class="mb-2 mt-2">${comment.message}</p>
                        <div class="d-flex align-items-center">
                            <span class="stats-badge badge bg-secondary me-2">
                                <i class="fas fa-heart"></i> ${comment.like_count || 0} likes
                            </span>
                            <span class="stats-badge badge bg-secondary">
                                <i class="fas fa-comment"></i> ${comment.comment_count || 0} replies
                            </span>
                        </div>
                        ${repliesHtml}
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = headerHtml + commentsHtml;
}

async function refreshComments(contentId, postId, pageId) {
    showLoading(true);
    
    try {
        const response = await fetch(`/admin-panel/api/posts/${postId}/comments/refresh`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                content_id: contentId,
                page_id: pageId,
                limit: 50
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showFlashMessage(`Comments refreshed successfully`);
            viewComments(contentId, postId);
        } else {
            showFlashMessage(`Error: ${data.error}`, 'danger');
        }
    } catch (error) {
        showFlashMessage(`Network error: ${error.message}`, 'danger');
    } finally {
        showLoading(false);
    }
}

async function bulkFetchComments() {
    if (!confirm('This will fetch comments for all posted content. This may take a while. Continue?')) {
        return;
    }
    
    showLoading(true);
    
    try {
        const response = await fetch('/admin-panel/api/comments/bulk-fetch', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showFlashMessage(`Bulk fetch completed: ${data.successful_fetches}/${data.total_posts_processed} successful, ${data.total_comments_fetched} total comments fetched`);
        } else {
            showFlashMessage(`Error: ${data.error}`, 'danger');
        }
    } catch (error) {
        showFlashMessage(`Network error: ${error.message}`, 'danger');
    } finally {
        showLoading(false);
    }
}

function openReplyModal(commentId, pageId, commenterName) {
    currentCommentId = commentId;
    currentPageId = pageId;
    
    document.getElementById('replyMessage').value = '';
    document.getElementById('replyError').style.display = 'none';
    document.querySelector('#replyModal .modal-title').textContent = `Reply to ${commenterName}`;
    
    const modal = new bootstrap.Modal(document.getElementById('replyModal'));
    modal.show();
}

async function submitReply() {
    const message = document.getElementById('replyMessage').value.trim();
    const errorDiv = document.getElementById('replyError');
    
    if (!message) {
        errorDiv.textContent = 'Please enter a reply message';
        errorDiv.style.display = 'block';
        return;
    }
    
    try {
        const response = await fetch(`/admin-panel/api/comments/${currentCommentId}/reply`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                page_id: currentPageId,
                message: message
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showFlashMessage('Reply posted successfully');
            const modal = bootstrap.Modal.getInstance(document.getElementById('replyModal'));
            modal.hide();
            
            // Refresh the comments view if it's currently visible
            const commentsView = document.getElementById('commentsView');
            if (commentsView.style.display !== 'none') {
                // Find the current content and post IDs and refresh
                // This is a simplified refresh - in production you might want to store these globally
                location.reload();
            }
        } else {
            errorDiv.textContent = data.error;
            errorDiv.style.display = 'block';
        }
    } catch (error) {
        errorDiv.textContent = `Network error: ${error.message}`;
        errorDiv.style.display = 'block';
    }
}

async function deleteComment(commentId, pageId) {
    if (!confirm('Are you sure you want to delete this comment? This action cannot be undone.')) {
        return;
    }
    
    showLoading(true);
    
    try {
        const response = await fetch(`/admin-panel/api/comments/${commentId}/delete`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                page_id: pageId
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showFlashMessage('Comment deleted successfully');
            // Refresh the current view
            location.reload();
        } else {
            showFlashMessage(`Error: ${data.error}`, 'danger');
        }
    } catch (error) {
        showFlashMessage(`Network error: ${error.message}`, 'danger');
    } finally {
        showLoading(false);
    }
}
</script>

<!-- Include Bootstrap JS if not already included -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

{% endblock %}
